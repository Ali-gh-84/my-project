<div class="enter-info">
  <nz-collapse>

    <ng-container *ngFor="let p of panels; let i = index; trackBy: trackPanel">

      <nz-collapse-panel
        class="collapse-panel"
        [nzHeader]="p.name"
        [nzActive]="p.active"
        [nzDisabled]="!p.active"
        [ngStyle]="{
     'background-color': p.active ? theme.overlay : theme.panels,
     'color': theme.high
  }">

        <form [formGroup]="p.form" nz-form nzLayout="vertical">
          <nz-row [nzGutter]="[16,16]" class="cont">

            <ng-container *ngIf="p.extraTexts">
              <ng-container *ngFor="let t of p.extraTexts">
                <p class="para">{{ t.text }}</p>
              </ng-container>
            </ng-container>

            <ng-container *ngIf="p.showEducationHistory && educationHistory.length > 0">
              <div class="education-table-wrapper">
                <nz-table [nzData]="educationHistory" [nzShowPagination]="false">
                  <thead [style.background-color]="theme.light + ' !important'">
                  <tr>
                    <th class="th th1">کد دانشجویی</th>
                    <th class="th">عنوان رشته</th>
                    <th class="th">بخش</th>
                    <th class="th">شروع</th>
                    <th class="th">پایان</th>
                    <th class="th">وضعیت</th>
                    <th class="th">معدل</th>
                    <th class="th th2">آخرین ویرایش</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let e of educationHistory">
                    <td>{{ e.studentCode }}</td>
                    <td>{{ e.fieldTitle }}</td>
                    <td>{{ e.sectionTitle }}</td>
                    <td>{{ e.startYear }} - {{ e.startSemester }}</td>

                    <td>
                      <ng-container *ngIf="e.endYear; else noEnd">
                        {{ e.endYear }} - {{ e.endSemester }}
                      </ng-container>
                      <ng-template #noEnd>-</ng-template>
                    </td>

                    <td>{{ e.statusTitle }}</td>
                    <td>{{ e.average }}</td>
                    <td>{{ e.modifiedTime }}</td>
                  </tr>
                  </tbody>
                </nz-table>
              </div>
            </ng-container>

            <ng-container *ngFor="let field of p.fields; trackBy: trackField">

              <ng-container *ngIf="field.type === 'checkbox-group'; else normalField">
                <div class="score-section" *ngIf="field.hint">
                  <p class="hint">{{ field.hint }}</p>
                </div>

                <div class="options" [formArrayName]="field.controlName">
                  <ng-container *ngFor="let opt of getOptions(field); let j = index; trackBy: trackOption">
                    <div class="checkbox-with-upload">
                      <div class="checkbox-item">
                        <label nz-checkbox [formControlName]="j">
                          {{ opt.label }}
                        </label>

                        <ng-container *ngIf="isCheckboxChecked(p.form, field.controlName, j)">
                          <!-- برای امتیازات -->
                          <ng-container *ngIf="field.controlName === 'scores'">

                            <app-file-uploader
                              [form]="scoreFilesForm"
                              [controlName]="'score_' + opt.value"
                              type="document"
                              accept=".pdf,.jpg,.jpeg,.png"
                              [placeholder]="' بارگذاری فایل'"
                              [multiple]="true"
                              [folderName]="'register'"
                              [disabled]="scoreFilesForm.get('score_' + opt.value)?.value"
                              (upload)="onScoreFileUpload(field.controlName, opt.value, $event)"
                              (remove)="handleScoreFileRemove(opt.value)">
                            </app-file-uploader>

                            <div *ngIf="scoreFilesForm.get('score_' + opt.value)?.value?.url"
                                 class="uploaded-file-box2">

                                <span class="file-name">
                                  {{ scoreFilesForm.get('score_' + opt.value)?.value?.name }}
                                </span>

                              <button type="button"
                                      class="remove-btn"
                                      (click)="handleScoreFileRemove(opt.value)">
                                ×
                              </button>
                            </div>

                          </ng-container>

                          <!-- برای معافیت‌ها -->
                          <ng-container *ngIf="field.controlName === 'exemptions'">
                            <app-file-uploader
                              [form]="exemptionFilesForm"
                              [controlName]="'exemption_' + opt.value"
                              type="document"
                              accept=".pdf,.jpg,.jpeg,.png"
                              [placeholder]="' بارگذاری فایل'"
                              [multiple]="true"
                              [folderName]="'register'"
                              [disabled]="exemptionFilesForm.get('exemption_' + opt.value)?.value"
                              (upload)="onExemptionFileUpload(field.controlName, opt.value, $event)"
                              (remove)="handleExemptionFileRemove(opt.value)">
                            </app-file-uploader>

                            <div *ngIf="exemptionFilesForm.get('exemption_' + opt.value)?.value?.url"
                                 class="uploaded-file-box2">

                                <span class="file-name">
                                  {{ exemptionFilesForm.get('exemption_' + opt.value)?.value?.name }}
                                </span>

                              <button type="button"
                                      class="remove-btn"
                                      (click)="handleExemptionFileRemove(opt.value)">
                                ×
                              </button>
                            </div>
                          </ng-container>

                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>

              <ng-template #normalField>
                <nz-col nzXs="24" nzSm="24" nzMd="12" nzLg="8">
                  <nz-form-item>
                    <nz-form-label [nzRequired]="field.required">
                      <div class="label-custom">
                        {{ field.label }}
                      </div>
                    </nz-form-label>

                    <nz-form-control [nzHasFeedback]="field.type!=='select' && field.type!=='date'"
                                     [nzErrorTip]="validationTpl">

                      <ng-container [ngSwitch]="field.type">

                        <input *ngSwitchCase="'text'" nz-input [formControlName]="field.controlName"
                               class="input custom-input">

                        <input *ngSwitchCase="'tel'" nz-input type="tel" [formControlName]="field.controlName"
                               class="input custom-input">

                        <input *ngSwitchCase="'email'" nz-input type="email" [formControlName]="field.controlName"
                               class="input custom-input">

                        <input *ngSwitchCase="'number'" nz-input type="number"
                               [min]="field.min" [max]="field.max"
                               [formControlName]="field.controlName"
                               class="input custom-input">

                        <nz-select *ngSwitchCase="'select'"
                                   nzShowSearch nzAllowClear
                                   [nzPlaceHolder]="'انتخاب ' + field.label"
                                   (ngModelChange)="onSelectChange(field.controlName, $event)"
                                   [formControlName]="field.controlName">
                          <nz-option *ngFor="let opt of getOptions(field); trackBy: trackOption"
                                     [nzValue]="opt.value"
                                     [nzLabel]="opt.label">
                          </nz-option>
                        </nz-select>

                        <ng-container *ngSwitchCase="'date'">
                          <app-jalali-date-picker [formControlName]="field.controlName"></app-jalali-date-picker>
                        </ng-container>

                      </ng-container>

                    </nz-form-control>

                    <ng-template #validationTpl>
                      <app-validation [control]="p.form.get(field.controlName)"></app-validation>
                    </ng-template>

                  </nz-form-item>
                </nz-col>
              </ng-template>

            </ng-container>

            <ng-container *ngIf="p.name === 'سوابق تحصیلی'">
              <nz-col nzXs="24" nzSm="24" nzMd="16" nzLg="12">

                <nz-form-label [nzRequired]="false">
                  <div class="label-custom">
                    مدرک تحصیلی
                  </div>
                </nz-form-label>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap">
                  <app-file-uploader
                    [form]="educationFilesForm"
                    controlName="education_file"
                    [multiple]="true"
                    [placeholder]="'بارگذاری فایل'"
                    folderName="register"
                    [style.background-color]="theme.primary"
                    style="border: none; border-radius: 8px; height: 40px; min-width: 140px;"
                    (upload)="onEducationFileUpload($event)"
                    (remove)="handleEducationFileRemove()">
                  </app-file-uploader>
                </div>

                <div *ngIf="educationFilesForm.get('education_file')?.value" class="uploaded-file-box">
                    <span class="file-name">
                      education file
                    </span>

                  <button type="button"
                          class="remove-btn"
                          (click)="handleEducationFileRemove()">
                    ×
                  </button>
                </div>
              </nz-col>
            </ng-container>
          </nz-row>
          <div class="btn-group-end">
            <button *ngIf="i > 0"
                    nz-button
                    nzType="default"
                    [style.background-color]="theme.light"
                    class="btn-finish"
                    (click)="goBack(i)">
              مرحله قبل
            </button>

            <div *ngIf="i === 0" style="width: 120px;"></div>

            <ng-container *ngIf="i < panels.length - 1; else finalSubmit">
              <button nz-button
                      nzType="primary"
                      [style.background-color]="theme.light"
                      class="btn-finish"
                      [class.loader]="loadingPanels[i]"
                      (click)="goNext(i)">
                مرحله بعد
              </button>
            </ng-container>

            <ng-template #finalSubmit>
              <button nz-button
                      nzType="primary"
                      class="btn-finish"
                      [style.background-color]="theme.light"
                      (click)="submitAll()">
                ثبت نهایی و ارسال اطلاعات
              </button>
            </ng-template>

          </div>
        </form>

      </nz-collapse-panel>

    </ng-container>

  </nz-collapse>
</div>
